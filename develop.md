### **校园网上网账号管理系统 - 开发方案**

#### **一、 核心思路与数据模型 (The Big Picture)**

我们的系统本质上是一个小型的数据库应用。它围绕一个核心数据表 **`上网账号表`** 运转，记录每一个上网账号从“入库”到“绑定”再到“过期/释放”的全过程。

为了实现这个目标，我建议在系统内部建立下面几张数据表（你可以把它想象成几个互相有关联的Excel表）：

1.  **`上网账号表 (isp_accounts)`**: ISP账号资源池！
    * `账号` (文本, 主键): 唯一的移动/联通/电信账号。
    * `账号类型` (文本): 如 "202409", "0元账号"。
    * `状态` (文本): "未使用", "已使用", "已过期"。
    * `生命周期开始日期` (日期): 根据 `账号类型` 自动计算，如 2024-09-01。
    * `生命周期结束日期` (日期): 根据 `账号类型` 或 "0元账号" 设置来计算，如 2025-09-01。
    * `绑定的学号` (文本): 从用户列表同步获得绑定信息。
    * `绑定的套餐到期日` (日期): 从用户列表同步，用于判断是否能自动释放。

2.  **`用户列表表 (user_list)`**: 实际绑定关系数据（月度校准）！
    * `用户账号` (文本, 主键): 学生账号
    * `绑定套餐` (文本): 套餐名称
    * `用户姓名` (文本): 真实姓名
    * `用户类别` (文本): 本科生/研究生/教职工
    * `移动账号` (文本): 绑定的ISP账号
    * `到期日期` (日期): 套餐到期时间
    * `导入时间`, `更新时间`: 数据管理时间戳

3.  **`缴费记录表 (payment_logs)`**: 用来处理增量绑定。
    * `记录ID` (数字, 主键)
    * `学号` (文本)
    * `缴费时间` (日期时间)
    * `缴费金额` (数字)
    * `处理状态` (文本): "待处理", "已处理", "处理失败" (例如，没有可用账号)。

4.  **`系统设置表 (system_settings)`**: 存放一些全局配置。
    * `配置项` (文本, 主键): 如 "上次缴费导入时间", "上次用户列表导入时间", "0元账号启用状态", "0元账号有效期"。
    * `配置值` (文本): 对应的值。

#### **二、 推荐技术栈 (Tools for the Job)**

考虑到你“快捷开发、数据准确”的核心诉求，我强烈推荐以下组合：

* **编程语言: Python**
    * 理由：语法简单，上手快，处理数据和文件是它的强项，有海量的库可以用，开发效率极高！

* **数据处理: Pandas库**
    * 理由：Python里处理Excel文件的“神器”，读写Excel就像呼吸一样简单自然。

* **数据库: SQLite**
    * 理由：一个轻量级的数据库，不需要安装和配置，就是一个单独的文件。Python内置就支持，完美满足我们存储少量数据的需求，简单可靠。

* **用户界面 (UI): Streamlit库 (强烈推荐!)**
    * 理由：你不需要写任何前端代码(HTML/CSS/JS)，只需要写Python代码，就能快速生成一个带按钮、可以上传/下载文件、显示表格的网页界面。对于你这个需求来说，简直是“降维打击”，开发速度飞快！

#### **三、 详细功能模块拆解 (Step-by-Step Logic)**

##### **功能1：导入上网账户**

* **目标：** 初始化和补充你的上网账号池。
* **输入：** `移动账户`, `账号类型`, `使用状态` 的Excel文件。
* **实现逻辑：**
    1.  界面上提供一个“上传账号文件”的按钮。
    2.  程序读取上传的Excel文件。
    3.  遍历每一行数据：
        * 用`移动账户`去 **`上网账号表`** 里查询是否存在。
        * **如果不存在**：这是一条新记录。
            * 根据 `账号类型` 计算 `生命周期开始/结束日期`。
                * 如果是 "202409" 这种格式，开始日期为 `2024-09-01`，结束日期为 `2025-09-01`。
                * 如果是 "0元账号"，则根据 **`系统设置表`** 里的配置来决定结束日期。
            * 将这条新记录插入到 **`上网账号表`**，`状态` 根据Excel里的值设定（如果为空则设为 "未使用"）。
        * **如果已存在**：更新这条记录的 `账号类型` 和 `使用状态` 即可。

##### **功能2：导入校园网绑定详情 (数据校准)**

* **目标：** 定期（比如每月）同步计费系统的最新绑定状态，确保我们的系统数据和官方一致。
* **输入：** 从后台导出的包含超多列的那个Excel。
* **实现逻辑：**
    1.  界面提供一个“上传绑定详情”的按钮。
    2.  程序读取Excel，只关心 `用户账号`, `移动账号`, `到期日期` 这几列。
    3.  遍历每一行数据：
        * 如果 `移动账号` 不为空：
            * 去 **`上网账号表`** 里找到这个 `移动账号`。
            * 更新它的信息：`状态` 改为 "已使用"，`绑定的学号` 填上 `用户账号`，`绑定的套餐到期日` 填上 `到期日期`。

##### **功能3：导入收费信息 & 生成绑定文件 (核心流程)**

这个功能我建议拆分为两个步骤，这样逻辑更清晰，也更安全。

**步骤A：导入收费信息**

* **目标：** 只导入新增的收费记录，不做绑定操作。
* **输入：** `用户账号`, `移动账号`, `收费时间`, `收费金额` 的Excel文件。
* **实现逻辑：**
    1.  程序先从 **`系统设置表`** 读取 `上次缴费导入时间`。
    2.  读取上传的收费Excel，筛选出所有 `收费时间` > `上次缴费导入时间` 的记录。
    3.  将这些新的、未处理过的记录，插入到 **`缴费记录表`**，`处理状态` 设为 "待处理"。
    4.  更新 **`系统设置表`** 里的 `上次缴费导入时间` 为本次导入文件中的最新时间。

**步骤B：执行绑定 & 生成批量修改文件**

* **目标：** 处理所有“待处理”的缴费记录，并生成最终的Excel。
* **实现逻辑：**
    1.  界面上有一个醒目的“开始处理并生成绑定文件”按钮。
    2.  点击后，程序开始工作：
        * 从 **`缴费记录表`** 中查询所有 `处理状态` 为 "待处理" 的记录。
        * 创建一个用于生成Excel的临时列表 `results`。
        * 遍历每一条待处理的缴费记录（我们称之为`payment`）：
            * 去 **`上网账号表`** 寻找一个可用的账号：`SELECT * FROM isp_accounts WHERE 状态 = '未使用' AND 生命周期结束日期 > 当前日期 LIMIT 1`。
            * **如果找到了可用的账号`acc`**:
                * 将 `(payment.学号, acc.账号)` 这对组合添加到 `results` 列表里。
                * 更新 **`上网账号表`** 中 `acc` 这条记录：`状态`="已使用", `绑定的学号`=`payment.学号`。
                * 更新 **`缴费记录表`** 中 `payment` 这条记录：`处理状态`="已处理"。
            * **如果没找到**:
                * 更新 **`缴费记录表`** 中 `payment` 这条记录：`处理状态`="处理失败"。
                * （可选）在界面上给出提示：“学号 XXX 因无可用上网账号而绑定失败！”
    3.  所有待处理记录遍历完毕后，使用 `results` 列表生成Excel文件。
    4.  Excel的列头为：`账号`, `移动账号`, `移动密码`, `联通账号`, `联通密码`, `电信账号`, `电信密码`。
    5.  将 `results` 里的数据填入前两列，后面所有列都保留为空！
    6.  提供下载链接，让你下载这份可以直接导入计费系统的Excel。

##### **功能4：查询列表 & 系统维护**

这是一个仪表盘/管理后台，让你对整个系统状态一目了然。

* **查询功能：**
    * **账号池概览：** 显示 "未使用"、"已使用"、"已过期" 状态的账号各有多少个。
    * **详细列表：** 一个可以搜索和筛选的 **`上网账号表`** 全览，可以看到每个账号的详细状态。
    * **失败列表：** 显示 **`缴费记录表`** 中所有 "处理失败" 的记录，方便你排查原因（通常是账号池不够了）。

* **系统维护功能（自动化脚本）：**
    * 这个功能最好是每天自动执行一次，或者在你需要时手动点击一个“每日维护”按钮。
    * **逻辑1 (自动释放)：** 查找 **`上网账号表`** 中所有 `状态`="已使用" 并且 `绑定的套餐到期日` < 今天的记录。如果它的 `生命周期结束日期` 还没到，就把它更新为：`状态`="未使用", `绑定的学号`=空, `绑定的套餐到期日`=空。
    * **逻辑2 (自动过期)：** 查找 **`上网账号表`** 中所有 `生命周期结束日期` < 今天的记录，将它们的 `状态` 直接更新为 "已过期"。
    * **0元账号设置：** 提供一个简单的界面，可以让你修改 **`系统设置表`** 里的 "0元账号启用状态" 和 "0元账号有效期"。


### **系统页面设计方案（多页面架构）**

系统采用Streamlit多页面应用架构，每个功能模块独立为一个页面，便于维护和扩展。

#### **1. 页面一：📊 首页 / 仪表盘 (app.py)**

访问地址：http://localhost:8501

这是系统主页，提供全局状态概览和快捷操作。

  * **页面目标：** 快速概览核心数据，并提供最常用操作的入口。
  * **包含功能/组件：**
    1.  **核心数据看板 (Key Metrics):**
          * **`可用账号`**: 显示当前"未使用"且未过期的账号总数。
          * **`待处理缴费`**: 已导入但还未执行绑定的缴费记录数。
          * **`已使用账号`**: 当前绑定中的账号数量。
          * **`已过期账号`**: 生命周期结束的账号数量。

    2.  **快捷操作区 (Quick Actions):**
          * 快速上传缴费文件并导入
          * 一键执行绑定任务并生成导出文件
          * 系统维护快捷入口

    3.  **系统状态信息:**
          * 上次缴费导入时间
          * 上次用户列表导入时间
          * 上次自动维护执行时间
          * 0元账号配置状态

#### **2. 页面二：🗂️ 账号管理 (pages/1_🗂️_账号管理.py)**

访问地址：http://localhost:8501/🗂️_账号管理

专门管理ISP账号池（不包含绑定关系）。

  * **页面目标：** 管理纯ISP资源池，导入账号、搜索筛选、批量操作。
  * **包含功能/组件：**
    1.  **导入账号模块:**
          * 上传账号Excel文件（移动账户、账号类型、使用状态）
          * 下载导入模板
          * 处理结果反馈和错误显示

    2.  **搜索与筛选:**
          * 按账号、学号、状态、类型搜索筛选
          * 支持复合条件查询
          * 彩色状态显示

    3.  **批量操作:**
          * 释放过期绑定
          * 标记过期账号
          * 导出搜索结果

#### **3. 页面三：👥 用户列表 (pages/2_👥_用户列表.py)**

访问地址：http://localhost:8501/👥_用户列表

管理实际用户绑定关系，每月导入进行数据校准。

  * **页面目标：** 管理真实用户绑定关系，执行数据校准。
  * **包含功能/组件：**
    1.  **用户列表导入:**
          * 上传用户列表Excel文件（用户账号、绑定套餐、用户姓名、用户类别、移动账号、到期日期）
          * 支持用户信息的完整管理

    2.  **数据校准功能:**
          * 将用户列表的绑定关系同步到账号池
          * 更新账号状态和绑定信息
          * 确保数据一致性

    3.  **用户查询管理:**
          * 按用户账号、姓名、类别搜索
          * 用户统计信息展示
          * 用户列表导出功能

#### **4. 页面四：🚀 绑定与导出 (pages/3_🚀_绑定导出.py)**

访问地址：http://localhost:8501/🚀_绑定导出

核心业务流程：缴费处理和账号绑定。

  * **页面目标：** 完成"导入缴费 → 处理绑定 → 生成导出"的完整流程。
  * **包含功能/组件：**
    1.  **第一步：导入缴费信息**
          * 上传收费Excel文件
          * 增量处理（只导入新记录）
          * 待处理记录统计和详情

    2.  **第二步：执行绑定任务**
          * 自动账号分配算法
          * 实时处理进度反馈
          * 绑定结果统计展示

    3.  **第三步：下载导出文件**
          * 批量修改文件生成
          * 历史导出文件管理
          * 绑定失败记录处理

#### **5. 页面五：⚙️ 系统设置 (pages/4_⚙️_系统设置.py)**

访问地址：http://localhost:8501/⚙️_系统设置

系统配置和维护中心。

  * **页面目标：** 管理全局配置，执行系统维护任务。
  * **包含功能/组件：**
    1.  **0元账号配置:**
          * 启用/禁用0元账号特殊有效期
          * 设置统一到期日期
          * 配置持久化保存

    2.  **系统维护:**
          * 自动维护任务（释放过期绑定、标记过期账号）
          * 手动维护操作
          * 维护历史记录

    3.  **高级设置:**
          * 数据库清理操作
          * 系统时间戳重置
          * 系统信息和统计

